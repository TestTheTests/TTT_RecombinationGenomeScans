# Hapflk Analysis

This folder contains the scripts used to perform a hapflk analysis on a collection of VCFs

## K selection

K (number of clusters) selection was done by using the imputeqc package provided by Gennady Khvorykh [here](https://github.com/inzilico/imputeqc).
The process was computationally expensive, so I tested 3 values (K=5, K=10, K=15) on a small subset of the data (chromosome 1 of simulation 10900).
This imputeqc package follows the cross-validation procedure assumed in fastPHASE, where a proportion of the genotypes in the file are masked and
fastPHASE is made to predict the missing genotypes using the number of clusters being tested. I used the imputeqc defaults in the masking process,
which were to create 5 different masked datasets with 10% of the genotypes masked in each one. I then used the package to calculate the fastPHASE
error rate for each mask and find the mean error rate for each value of K. 

K=10 had a 0.0485552 mean error rate  
K=15 had a 0.0390178 mean error rate  
K=20 had a 0.0328386 mean error rate  

I selected K=15 to use in the analysis to keep computational costs down   

## run_hapflk.sh

This script is designed so that it can be easily run on a remote linux server (longest part of analysis). It depends on the scripts in the src folder
in this repository. The process:

	1) Calculate kinship matrix for full dataset (all SNPs, unpruned)

	2) Calculate kinship matrix for pruned dataset

	3) Split data set into 10 separate files, one for each chromosome

	4) Run hapflk on each chromosome individually using 3 combinations of kinship matrices and data:
		- full dataset matrix, full dataset
		- pruned dataset matrix, pruned dataset
		- pruned dataset matrix, full dataset

	5) Combine results from all chromosomes into one table

## Calculating p-values

The hapflk [documenation](https://forge-dga.jouy.inra.fr/documents/588) includes a python script (scaling_chi2_hapflk.py) for calculating p-values
from hapflk results. It depends on several python packages, some of which were not installed in my remote environment, so I kept this part of the 
analysis separate from run_hapflk.sh. A simple bash for loop was used to apply scaling_chi2_hapflk.py to each table created in step 5 of the 
hapflk analysis above.

## combine hapflk_tables.R

combine_hapflk_tables.R is an Rscript provided in "src" to combine the scaled results from each of the 3 combinations of kinship matrices and data 
into one table that makes the results easy to compare. It can take command line arguments or will just run on defaults if there
are none provided. These are the 5 arguments it can take, unnamed and in this order:
	
	1) start       -- the first sim in the set
	2) end         -- the last sim in the set
	3) directory   -- where are the results tables located
	4) type of sim -- points the script to the names of the tables (ex "Invers)
	5) directory   -- where are the indexes of the quasi-indep alleles located

The final parameter allows the script to combine pruned and unpruned datsets, it points the script to where it can find a collection of files
generated by pruneSNPs.pl that tell the script which SNPs were kept after pruning.
	
